name: build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  macos-universal:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build universal2
        shell: bash
        run: |
          set -euo pipefail
          COMMIT=$(git rev-parse --short HEAD)
          export COMMIT
          TMP_BASE=$(mktemp -t ocr_buildXXXXXX)
          TMP="${TMP_BASE}.swift"
          trap 'rm -f "$TMP"' EXIT
          python3 - <<'PY' > "$TMP"
          import os
          commit = os.environ.get("COMMIT", "")
          if not commit:
              raise SystemExit("Error: COMMIT is empty")
          with open("ocr.swift", "r", encoding="utf-8") as f:
              data = f.read()
          data = data.replace("__GIT_COMMIT_VALUE__", commit, 1)
          print(data, end="")
          PY

          SDKROOT=$(xcrun --show-sdk-path)
          swiftc "$TMP" -o ocr_tool_arm64 -sdk "$SDKROOT" -target arm64-apple-macosx11.0
          swiftc "$TMP" -o ocr_tool_x86_64 -sdk "$SDKROOT" -target x86_64-apple-macosx11.0

          lipo -create -output ocr_tool ocr_tool_arm64 ocr_tool_x86_64
          rm -f ocr_tool_arm64 ocr_tool_x86_64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ocr_tool-universal2
          path: ocr_tool
